<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Flipbook — MPASI</title>

  <style>
    /* ===== Ive-ish Minimal, High Contrast ===== */
    :root{
      --bg: #eef1f5;
      --panel: #ffffff;
      --ink: #0b0c0d;
      --muted: #5b626e;
      --ring: rgba(0,0,0,.12);
      --accent: #111827;
      --radius: 22px;
      --shadow: 0 14px 50px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro Text", Inter, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1600px 800px at 50% -300px, #fff 0%, var(--bg) 60%, #e6eaf0 100%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .shell{display:grid;grid-template-rows:auto 1fr;height:100%}

    /* Frosted top bar */
    .nav{
      position:sticky; top:0; z-index:40;
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
      padding:12px 16px;
      background:rgba(255,255,255,.75);
      backdrop-filter:saturate(160%) blur(18px);
      border-bottom:1px solid var(--ring);
    }
    .brand{justify-self:center;font-weight:700;letter-spacing:.2px}
    .right{justify-self:end;display:flex;gap:8px;align-items:center}
    .counter{color:var(--muted);font-size:14px;min-width:84px;text-align:right}

    .stage{display:grid;place-items:center;padding:24px}
    .panel{
      width:min(100%, 1280px);
      border-radius:var(--radius);
      background:var(--panel);
      box-shadow: var(--shadow);
      padding:18px;             /* inner padding for rounded feel */
      overflow:auto;
    }

    /* Zoom wrapper scales the entire flipbook */
    .zoom-wrap{
      transform-origin: center top;
      transition: transform .2s ease;
      display:grid;
      place-items:center;
      width:100%;
    }

    /* The flipbook surface */
    #book{
      width:min(100%, 1200px);
      height:85vh;
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }

    /* Buttons & slider */
    .btn{
      appearance:none;border:1px solid var(--ring);background:#fff;color:var(--ink);
      padding:8px 10px;border-radius:999px;line-height:1;cursor:pointer;
      box-shadow:0 1px 0 rgba(0,0,0,.02),0 6px 20px rgba(0,0,0,.06);
      transition:transform .06s ease, box-shadow .2s ease, background .2s ease;
      font-size:14px
    }
    .btn:active{transform:scale(.98)}
    .btn:hover{box-shadow:0 8px 26px rgba(0,0,0,.1)}
    .sep{width:1px;height:22px;background:var(--ring);margin:0 2px;border-radius:1px}

    input[type="range"]{
      -webkit-appearance:none;appearance:none;width:140px;height:4px;background:#e6e9ee;border-radius:999px;outline:none;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;
      background:#fff;border:1px solid var(--ring);box-shadow:0 6px 18px rgba(0,0,0,.15);cursor:pointer
    }

    /* Loader */
    .loading{display:grid;place-items:center;gap:12px;height:85vh;color:var(--muted)}
    .progress{width:min(460px,72vw);height:8px;background:#e8ebf0;border-radius:999px;overflow:hidden;box-shadow:inset 0 0 1px rgba(0,0,0,.05)}
    .bar{height:100%;width:0%;background:var(--accent);transition:width .22s ease}
    .hint{font-size:12px;color:var(--muted)}

    @media (max-width:640px){
      #book{height:78vh}
      .nav{grid-template-columns:1fr auto auto}
      .brand{justify-self:start}
      .counter{display:none}
    }
  </style>

  <!-- Flip animation -->
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.js" defer></script>

  <!-- PDF.js primary (no defer) + fallback -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script>
    (function(){
      if(!window.pdfjsLib){
        var s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
        document.head.appendChild(s);
      }
    })();
  </script>
</head>
<body>
  <div class="shell">
    <div class="nav">
      <div class="brand">Flipbook</div>
      <div></div>
      <div class="right">
        <button class="btn" id="zoomOut" title="Zoom out">−</button>
        <input id="zoomRange" type="range" min="80" max="200" value="100" />
        <button class="btn" id="zoomIn" title="Zoom in">+</button>
        <div class="sep"></div>
        <div class="counter" id="pageCounter">Page 1 / 1</div>
        <button class="btn" id="prevBtn" title="Previous page">◀︎</button>
        <button class="btn" id="nextBtn" title="Next page">▶︎</button>
      </div>
    </div>

    <div class="stage">
      <div class="panel">
        <div class="zoom-wrap" id="zoomWrap">
          <div id="book">
            <div class="loading" id="loading">
              <div>
                <div style="font-weight:700; font-size:15px; margin-bottom:8px; color:#111">Rendering flipbook…</div>
                <div class="progress"><div class="bar" id="bar"></div></div>
                <div class="hint" id="hint">Preparing pages</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* Wait until pdfjs is available (handles fallback) */
async function waitForPdfjs(){
  for(let i=0;i<40;i++){ if(window.pdfjsLib) return window.pdfjsLib; await new Promise(r=>setTimeout(r,100)); }
  throw new Error('PDF.js failed to load');
}

window.addEventListener('load', async () => {
  const params = new URLSearchParams(location.search);
  const PDF_URL = params.get('file') || "pdf/mpasi.pdf";

  const zoomWrap = document.getElementById('zoomWrap');
  const zoomRange = document.getElementById('zoomRange');
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');

  // Zoom state
  let zoom = 1.0;
  const applyZoom = () => {
    zoomWrap.style.transform = `scale(${zoom})`;
    zoomRange.value = String(Math.round(zoom*100));
  };
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const setZoom = (z)=>{ zoom = clamp(z, 0.8, 2.0); applyZoom(); };

  // Controls
  zoomInBtn.addEventListener('click', ()=> setZoom(zoom + 0.1));
  zoomOutBtn.addEventListener('click', ()=> setZoom(zoom - 0.1));
  zoomRange.addEventListener('input', e=> setZoom(+e.target.value/100));
  // Double-click to zoom in/out
  zoomWrap.addEventListener('dblclick', ()=> setZoom(zoom < 1.25 ? 1.5 : 1.0));
  // Pinch zoom (basic)
  let startDist=null,startZoom=null;
  zoomWrap.addEventListener('touchmove', e=>{
    if(e.touches.length===2){
      const dx=e.touches[0].clientX - e.touches[1].clientX;
      const dy=e.touches[0].clientY - e.touches[1].clientY;
      const dist=Math.hypot(dx,dy);
      if(startDist==null){ startDist=dist; startZoom=zoom; }
      setZoom(startZoom * (dist/startDist));
      e.preventDefault();
    }
  }, {passive:false});
  zoomWrap.addEventListener('touchend', ()=>{ startDist=null; });

  // Keyboard zoom
  document.addEventListener('keydown', (e)=>{
    if(e.key==='+' || e.key==='=') setZoom(zoom + 0.1);
    if(e.key==='-' || e.key==='_') setZoom(zoom - 0.1);
  });

  // PDF.js
  let pdfjs;
  try { pdfjs = await waitForPdfjs(); }
  catch(e){
    document.getElementById('book').innerHTML = "<div style='padding:24px;color:#b91c1c'>Failed to load PDF.js library.</div>";
    return;
  }

  try {
    const v = pdfjs.version || '';
    if (v.startsWith('4.')) {
      pdfjs.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";
    } else {
      pdfjs.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
    }

    const loadingEl = document.getElementById('loading');
    const barEl = document.getElementById('bar');
    const hintEl = document.getElementById('hint');
    const bookEl = document.getElementById('book');
    const counterEl = document.getElementById('pageCounter');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // Render PDF pages -> images
    const task = pdfjs.getDocument(PDF_URL);
    const pdf = await task.promise;
    const pageCount = pdf.numPages;

    const scale = Math.min(2.2, (window.devicePixelRatio || 1) * 1.6);
    const images = [];
    let baseWidth = 800, baseHeight = 1120;

    for (let i = 1; i <= pageCount; i++) {
      hintEl.textContent = "Rendering page " + i + " / " + pageCount;
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { alpha: false });
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      await page.render({ canvasContext: ctx, viewport }).promise;

      if (i === 1) { baseWidth = canvas.width; baseHeight = canvas.height; }
      images.push(canvas.toDataURL('image/jpeg', 0.92));

      barEl.style.width = ((i / pageCount) * 100).toFixed(1) + "%";
      await new Promise(r => setTimeout(r, 8));
    }

    // Flipbook: 2-page spread (like a real book)
    const pageFlip = new St.PageFlip(bookEl, {
      width: baseWidth,
      height: baseHeight,
      size: "stretch",
      minWidth: 320,
      maxWidth: 2600,
      minHeight: 320,
      maxHeight: 4200,
      showCover: true,     // first page single, then spreads
      drawShadow: true,
      maxShadowOpacity: 0.25,
      flippingTime: 720,
      usePortrait: false,  // force spread on wide screens
      mobileScrollSupport: true,
    });
    pageFlip.loadFromImages(images);

    const updateCounter = () => {
      counterEl.textContent = "Page " + (pageFlip.getCurrentPageIndex() + 1) + " / " + pageFlip.getPageCount();
    };
    pageFlip.on('flip', updateCounter);
    pageFlip.on('init', updateCounter);
    pageFlip.on('update', updateCounter);

    prevBtn.addEventListener('click', () => pageFlip.flipPrev());
    nextBtn.addEventListener('click', () => pageFlip.flipNext());
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') pageFlip.flipPrev();
      if (e.key === 'ArrowRight') pageFlip.flipNext();
    });

    // Initial zoom (100%)
    applyZoom();
    // Remove loader
    loadingEl.remove();
    updateCounter();
  } catch (err) {
    console.error(err);
    const bookEl = document.getElementById('book');
    bookEl.innerHTML =
      "<div style='padding:24px;color:#b91c1c'>Failed to load flipbook.<br/>" +
      "Check: <code>" + (new URL(PDF_URL, location.href)).href + "</code><br/>" +
      "Error: <code>" + (err && (err.message || err.toString())) + "</code></div>";
  }
});
</script>
</body>
</html>
