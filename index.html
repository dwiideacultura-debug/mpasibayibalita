<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Flipbook — MPASI</title>

  <style>
    /* ====== Jony Ive-ish, High-Contrast Light ====== */
    :root{
      --bg: #f2f3f5;           /* canvas background */
      --card: #ffffff;         /* surfaces */
      --ink: #0b0c0d;          /* primary text */
      --muted: #5c636f;        /* secondary text */
      --ring: rgba(0,0,0,.12); /* borders */
      --accent: #111827;       /* controls / progress */
      --shadow: 0 10px 40px rgba(0,0,0,.14);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 600px at 50% -200px, #fff 0%, var(--bg) 60%, #eceef2 100%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .app{display:grid;grid-template-rows:auto 1fr;height:100%}

    /* Frosted glass top bar */
    .nav{
      position:sticky; top:0; z-index:30;
      display:flex; align-items:center; gap:12px;
      padding:14px 18px;
      background:rgba(255,255,255,.75);
      backdrop-filter:saturate(160%) blur(18px);
      border-bottom:1px solid var(--ring);
    }
    .brand{font-weight:700; letter-spacing:.2px; font-size:15px}
    .spacer{flex:1}

    /* Icon buttons – bold, tactile */
    .btn{
      appearance:none; border:1px solid var(--ring); background:var(--card);
      padding:10px 14px; border-radius:999px; font-size:14px; line-height:1;
      cursor:pointer; box-shadow:0 1px 0 rgba(0,0,0,.02), 0 6px 20px rgba(0,0,0,.06);
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
    }
    .btn:active{ transform: scale(.98) }
    .btn:hover{ box-shadow:0 6px 24px rgba(0,0,0,.10) }

    .counter{ color:var(--muted); font-size:14px }

    .stage{ display:grid; place-items:center; padding:28px }
    #book{
      width:min(100%, 1200px);
      height:85vh;                 /* lebih tinggi → lebih dramatic */
      margin:0 auto;
      border-radius:var(--radius);
      background:var(--card);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Loader */
    .loading{ display:grid; place-items:center; gap:16px; height:100%; text-align:center; color:var(--muted) }
    .progress{ width:min(460px,72vw); height:8px; background:#e8ebf0; border-radius:999px; overflow:hidden; box-shadow:inset 0 0 1px rgba(0,0,0,.05) }
    .bar{ height:100%; width:0%; background:var(--accent); transition: width .22s ease }
    .hint{ font-size:12px; color:var(--muted) }

    /* Mobile tweaks */
    @media (max-width: 640px){
      #book{ height:78vh; border-radius:16px }
      .nav{ padding:10px 12px }
    }
  </style>

  <!-- Flip animation -->
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.js" defer></script>

  <!-- PDF.js – primary (no defer) + fallback -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script>
    (function(){
      if(!window.pdfjsLib){
        var s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
        document.head.appendChild(s);
      }
    })();
  </script>
</head>
<body>
  <div class="app">
    <div class="nav">
      <div class="brand">Flipbook</div>
      <div class="spacer"></div>
      <div class="counter" id="pageCounter">Loading…</div>
      <button class="btn" id="prevBtn" title="Previous page">◀︎</button>
      <button class="btn" id="nextBtn" title="Next page">▶︎</button>
    </div>

    <div class="stage">
      <div id="book">
        <div class="loading" id="loading">
          <div>
            <div style="font-weight:700; font-size:15px; margin-bottom:8px; color:#111">Rendering flipbook…</div>
            <div class="progress"><div class="bar" id="bar"></div></div>
            <div class="hint" id="hint">Preparing pages</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* Wait until pdfjs is available (handles fallback) */
async function waitForPdfjs(){
  for(let i=0;i<40;i++){ if(window.pdfjsLib) return window.pdfjsLib; await new Promise(r=>setTimeout(r,100)); }
  throw new Error('PDF.js failed to load');
}

window.addEventListener('load', async () => {
  const params = new URLSearchParams(location.search);
  const PDF_URL = params.get('file') || "pdf/mpasi.pdf";

  let pdfjs;
  try { pdfjs = await waitForPdfjs(); } 
  catch(e){
    document.getElementById('book').innerHTML = "<div style='padding:24px;color:#b91c1c'>Failed to load PDF.js library.</div>";
    return;
  }

  try {
    // Set worker according to loaded version
    const v = pdfjs.version || '';
    if (v.startsWith('4.')) {
      pdfjs.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";
    } else {
      pdfjs.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
    }

    const loadingEl = document.getElementById('loading');
    const barEl = document.getElementById('bar');
    const hintEl = document.getElementById('hint');
    const bookEl = document.getElementById('book');
    const counterEl = document.getElementById('pageCounter');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // Debug: show current PDF path
    const probe = document.createElement('div');
    probe.className = 'hint';
    probe.innerHTML = 'PDF: <code>'+PDF_URL+'</code>';
    loadingEl.appendChild(probe);

    const task = pdfjs.getDocument(PDF_URL);
    const pdf = await task.promise;
    const pageCount = pdf.numPages;

    // High-def but efficient
    const scale = Math.min(2.2, (window.devicePixelRatio || 1) * 1.6);
    const images = [];
    let baseWidth = 800, baseHeight = 1120;

    for (let i = 1; i <= pageCount; i++) {
      hintEl.textContent = "Rendering page " + i + " / " + pageCount;
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { alpha: false });
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      await page.render({ canvasContext: ctx, viewport }).promise;

      if (i === 1) { baseWidth = canvas.width; baseHeight = canvas.height; }
      images.push(canvas.toDataURL('image/jpeg', 0.92));

      barEl.style.width = ((i / pageCount) * 100).toFixed(1) + "%";
      await new Promise(r => setTimeout(r, 12));
    }

    // Flipbook — spread 2 halaman
    const pageFlip = new St.PageFlip(bookEl, {
      width: baseWidth,
      height: baseHeight,
      size: "stretch",
      minWidth: 320,
      maxWidth: 2600,
      minHeight: 320,
      maxHeight: 4200,
      showCover: true,     // cover single → lalu spread
      drawShadow: true,
      maxShadowOpacity: 0.25,
      flippingTime: 750,
      usePortrait: false,  // force 2 halaman di layar lebar
      mobileScrollSupport: true,
    });
    pageFlip.loadFromImages(images);

    const updateCounter = () => {
      counterEl.textContent = "Page " + (pageFlip.getCurrentPageIndex() + 1) + " / " + pageFlip.getPageCount();
    };
    pageFlip.on('flip', updateCounter);
    pageFlip.on('init', updateCounter);
    pageFlip.on('update', updateCounter);

    prevBtn.addEventListener('click', () => pageFlip.flipPrev());
    nextBtn.addEventListener('click', () => pageFlip.flipNext());
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') pageFlip.flipPrev();
      if (e.key === 'ArrowRight') pageFlip.flipNext();
    });

    loadingEl.remove();
    updateCounter();
  } catch (err) {
    console.error(err);
    const bookEl = document.getElementById('book');
    bookEl.innerHTML =
      "<div style='padding:24px;color:#b91c1c'>Failed to load flipbook.<br/>" +
      "Check: <code>" + (new URL(PDF_URL, location.href)).href + "</code><br/>" +
      "Error: <code>" + (err && (err.message || err.toString())) + "</code></div>";
  }
});
</script>
</body>
</html>
