<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Flipbook — MPASI</title>
  <style>
    :root{--bg:#f8f9fb;--fg:#0b0c0d;--muted:#7a7f87;--ring:rgba(0,0,0,.06);--card:#fff}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);background:var(--bg);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .app{display:grid;grid-template-rows:auto 1fr;height:100%}
    .nav{position:sticky;top:0;backdrop-filter:saturate(180%) blur(16px);background:rgba(255,255,255,.7);border-bottom:1px solid var(--ring);padding:10px 14px;display:flex;align-items:center;gap:12px;z-index:10}
    .brand{font-weight:600;letter-spacing:.2px}
    .spacer{flex:1}
    .btn{border:1px solid var(--ring);background:var(--card);padding:8px 12px;border-radius:999px;font-size:14px;cursor:pointer;transition:transform .05s ease, box-shadow .2s ease;box-shadow:0 1px 0 rgba(0,0,0,.02),0 2px 10px rgba(0,0,0,.04)}
    .btn:active{transform:scale(.98)}
    .counter{color:var(--muted);font-size:14px}
    .stage{display:grid;place-items:center;padding:24px}
    #book{width:min(100%,1100px);height:80vh;margin:0 auto;border-radius:20px;box-shadow:0 8px 40px rgba(0,0,0,.08);background:var(--card);overflow:hidden}
    .loading{display:grid;place-items:center;gap:16px;color:var(--muted);height:100%;text-align:center}
    .progress{width:min(420px,70vw);height:6px;background:#e8eaef;border-radius:999px;overflow:hidden;box-shadow:inset 0 0 1px rgba(0,0,0,.04)}
    .bar{height:100%;width:0%;background:#111827;transition:width .2s ease}
    .hint{font-size:12px;color:var(--muted)}
    @media (max-width:640px){#book{height:72vh;border-radius:14px}.nav{padding:8px 10px}}
  </style>
<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
</head>
<body>
  <div class="app">
    <div class="nav">
      <div class="brand">Flipbook</div>
      <div class="spacer"></div>
      <div class="counter" id="pageCounter">Loading…</div>
      <button class="btn" id="prevBtn" title="Previous page">◀︎</button>
      <button class="btn" id="nextBtn" title="Next page">▶︎</button>
    </div>
    <div class="stage">
      <div id="book">
        <div class="loading" id="loading">
          <div>
            <div style="font-weight:600;margin-bottom:6px">Rendering flipbook…</div>
            <div class="progress"><div class="bar" id="bar"></div></div>
            <div class="hint" id="hint">Preparing pages</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
window.addEventListener('load', async () => {
  const params = new URLSearchParams(location.search);
  // Allow override via ?file=pdf/xyz.pdf
  const PDF_URL = params.get('file') || "pdf/mpasi.pdf";
  try {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";
    
    const loadingEl = document.getElementById('loading');
    const barEl = document.getElementById('bar');
    const hintEl = document.getElementById('hint');
    const bookEl = document.getElementById('book');
    const counterEl = document.getElementById('pageCounter');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // Quick probe: show direct link to the PDF for debugging
    const probe = document.createElement('div');
    probe.className = 'hint';
    probe.innerHTML = 'PDF path: <code>'+PDF_URL+'</code>';
    loadingEl.appendChild(probe);

    const task = pdfjsLib.getDocument(PDF_URL);
    const pdf = await task.promise;
    const pageCount = pdf.numPages;

    const scale = Math.min(2.2, (window.devicePixelRatio || 1) * 1.5);
    const images = [];
    let baseWidth = 800, baseHeight = 1120;

    for (let i = 1; i <= pageCount; i++) {
      hintEl.textContent = "Rendering page " + i + " of " + pageCount;
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { alpha: false });
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      await page.render({ canvasContext: ctx, viewport }).promise;
      if (i === 1) { baseWidth = canvas.width; baseHeight = canvas.height; }
      images.push(canvas.toDataURL('image/jpeg', 0.92));
      barEl.style.width = ((i / pageCount) * 100).toFixed(1) + "%";
      await new Promise(r => setTimeout(r, 12));
    }

    const pageFlip = new St.PageFlip(bookEl, {
      width: baseWidth, height: baseHeight, size: "stretch",
      minWidth: 320, maxWidth: 2400, minHeight: 320, maxHeight: 4000,
      showCover: true, drawShadow: true, maxShadowOpacity: 0.2,
      flippingTime: 750, usePortrait: true, mobileScrollSupport: true,
    });
    pageFlip.loadFromImages(images);

    const updateCounter = () => {
      counterEl.textContent = "Page " + (pageFlip.getCurrentPageIndex() + 1) + " / " + pageFlip.getPageCount();
    };
    pageFlip.on('flip', updateCounter);
    pageFlip.on('init', updateCounter);
    pageFlip.on('update', updateCounter);
    prevBtn.addEventListener('click', () => pageFlip.flipPrev());
    nextBtn.addEventListener('click', () => pageFlip.flipNext());
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') pageFlip.flipPrev();
      if (e.key === 'ArrowRight') pageFlip.flipNext();
    });

    loadingEl.remove();
    updateCounter();
  } catch (err) {
    console.error(err);
    const bookEl = document.getElementById('book');
    bookEl.innerHTML = "<div style='padding:24px; color:#b91c1c'>Failed to load flipbook.<br/>" +
      "Check that your PDF exists at <code>" + (new URL(PDF_URL, location.href)).href + "</code>.<br/>" +
      "Error: <code>" + (err && (err.message || err.toString())) + "</code></div>";
  }
});
</script>
</body>
</html>
