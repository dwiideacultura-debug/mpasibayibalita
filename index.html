<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Flipbook â€” MPASI</title>

  <style>
    /* ===== Light theme (Ive-ish) ===== */
    :root{
      --bg: #eef1f5;
      --panel: #ffffff;
      --ink: #0b0c0d;
      --muted: #5b626e;
      --ring: rgba(0,0,0,.12);
      --accent: #111827;
      --radius: 22px;
      --shadow: 0 14px 50px rgba(0,0,0,.15);
    }
    /* ===== Dark theme (auto when fullscreen) ===== */
    .theme-dark{
      --bg: #0b0f14;
      --panel: #0f141b;
      --ink: #f2f4f8;
      --muted: #aab2bf;
      --ring: rgba(255,255,255,.14);
      --accent: #e5e7eb;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, "SF Pro Text", Inter, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1600px 800px at 50% -300px, #fff 0%, var(--bg) 60%, var(--bg) 100%);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      transition: background .25s ease, color .25s ease;
    }

    .shell{display:grid;grid-template-rows:auto 1fr;height:100%}

    /* Top bar */
    .nav{
      position:sticky; top:0; z-index:40;
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
      padding:12px 16px;
      background:rgba(255,255,255,.75);
      backdrop-filter:saturate(160%) blur(18px);
      border-bottom:1px solid var(--ring);
      transition: background .25s ease, border-color .25s ease;
    }
    .theme-dark .nav{ background:rgba(20,24,32,.55); border-bottom-color:var(--ring); }
    .brand{justify-self:center;font-weight:700;letter-spacing:.2px}
    .left{display:flex;gap:8px;align-items:center}
    .right{justify-self:end;display:flex;gap:8px;align-items:center}
    .counter{color:var(--muted);font-size:14px;min-width:88px;text-align:right}

    .stage{display:grid;place-items:center;padding:24px}
    .panel{
      width:min(100%, 1280px);
      border-radius:var(--radius);
      background:var(--panel);
      box-shadow: var(--shadow);
      padding:18px;
      overflow:auto;
      transition: background .25s ease, box-shadow .25s ease;
    }

    /* Zoom wrapper scales the whole flipbook */
    .zoom-wrap{
      transform-origin: center top;
      transition: transform .2s ease;
      display:grid;
      place-items:center;
      width:100%;
    }

    #book{
      width:min(100%, 1200px);
      height:85vh;
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }

    .btn{
      appearance:none;border:1px solid var(--ring);background:var(--panel);color:var(--ink);
      padding:8px 11px;border-radius:999px;line-height:1;cursor:pointer;
      box-shadow:0 1px 0 rgba(0,0,0,.02),0 6px 20px rgba(0,0,0,.06);
      transition:transform .06s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
      font-size:14px
    }
    .btn:active{transform:scale(.98)}
    .btn:hover{box-shadow:0 8px 26px rgba(0,0,0,.1)}
    .sep{width:1px;height:22px;background:var(--ring);margin:0 2px;border-radius:1px}

    input[type="range"]{
      -webkit-appearance:none;appearance:none;width:140px;height:4px;background:#e6e9ee;border-radius:999px;outline:none;
      transition: background .2s ease;
    }
    .theme-dark input[type="range"]{ background:#2a313b; }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;
      background:var(--panel);border:1px solid var(--ring);box-shadow:0 6px 18px rgba(0,0,0,.15);cursor:pointer
    }

    .loading{display:grid;place-items:center;gap:12px;height:85vh;color:var(--muted)}
    .progress{width:min(460px,72vw);height:8px;background:#e8ebf0;border-radius:999px;overflow:hidden;box-shadow:inset 0 0 1px rgba(0,0,0,.05)}
    .theme-dark .progress{ background:#222833; }
    .bar{height:100%;width:0%;background:var(--accent);transition:width .22s ease}
    .hint{font-size:12px;color:var(--muted)}

    @media (max-width:640px){
      #book{height:78vh}
      .nav{grid-template-columns:auto 1fr auto}
      .brand{justify-self:center}
      .counter{display:none}
    }

    /* Fullscreen tweaks */
    .is-fullscreen #book{ height:92vh; }
  </style>

  <!-- Flip animation -->
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.js" defer></script>

  <!-- PDF.js primary (no defer) + fallback -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script>
    (function(){
      if(!window.pdfjsLib){
        var s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
        document.head.appendChild(s);
      }
    })();
  </script>
</head>
<body>
  <div class="shell" id="appShell">
    <div class="nav">
      <div class="left">
        <button class="btn" id="themeBtn" title="Toggle dark / light">ðŸŒ“</button>
        <button class="btn" id="fullBtn" title="Fullscreen">â›¶ Full</button>
      </div>
      <div class="brand">Flipbook MPASI by Yunesti </div>
      <div class="right">
        <button class="btn" id="zoomOut" title="Zoom out">âˆ’</button>
        <input id="zoomRange" type="range" min="80" max="200" value="100" />
        <button class="btn" id="zoomIn" title="Zoom in">+</button>
        <div class="sep"></div>
        <div class="counter" id="pageCounter">Page 1 / 1</div>
        <button class="btn" id="prevBtn" title="Previous page">â—€ï¸Ž</button>
        <button class="btn" id="nextBtn" title="Next page">â–¶ï¸Ž</button>
      </div>
    </div>

    <div class="stage">
      <div class="panel" id="panel">
        <div class="zoom-wrap" id="zoomWrap">
          <div id="book">
            <div class="loading" id="loading">
              <div>
                <div style="font-weight:700; font-size:15px; margin-bottom:8px;">Rendering flipbookâ€¦</div>
                <div class="progress"><div class="bar" id="bar"></div></div>
                <div class="hint" id="hint">Preparing pages</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* Wait until pdfjs is available (handles fallback) */
async function waitForPdfjs(){
  for(let i=0;i<40;i++){ if(window.pdfjsLib) return window.pdfjsLib; await new Promise(r=>setTimeout(r,100)); }
  throw new Error('PDF.js failed to load');
}

window.addEventListener('load', async () => {
  const params = new URLSearchParams(location.search);
  const PDF_URL = params.get('file') || "pdf/mpasi.pdf";

  const appShell = document.getElementById('appShell');
  const panel = document.getElementById('panel');
  const zoomWrap = document.getElementById('zoomWrap');
  const zoomRange = document.getElementById('zoomRange');
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');
  const themeBtn = document.getElementById('themeBtn');
  const fullBtn = document.getElementById('fullBtn');

  // ===== Zoom =====
  let zoom = 1.0;
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const applyZoom = () => { zoomWrap.style.transform = `scale(${zoom})`; zoomRange.value = String(Math.round(zoom*100)); };
  const setZoom = (z)=>{ zoom = clamp(z, 0.8, 2.0); applyZoom(); };
  zoomInBtn.addEventListener('click', ()=> setZoom(zoom + 0.1));
  zoomOutBtn.addEventListener('click', ()=> setZoom(zoom - 0.1));
  zoomRange.addEventListener('input', e=> setZoom(+e.target.value/100));
  zoomWrap.addEventListener('dblclick', ()=> setZoom(zoom < 1.25 ? 1.5 : 1.0));
  let startDist=null,startZoom=null;
  zoomWrap.addEventListener('touchmove', e=>{
    if(e.touches.length===2){
      const dx=e.touches[0].clientX - e.touches[1].clientX;
      const dy=e.touches[0].clientY - e.touches[1].clientY;
      const dist=Math.hypot(dx,dy);
      if(startDist==null){ startDist=dist; startZoom=zoom; }
      setZoom(startZoom * (dist/startDist));
      e.preventDefault();
    }
  }, {passive:false});
  zoomWrap.addEventListener('touchend', ()=>{ startDist=null; });

  // ===== Theme toggle (manual) =====
  themeBtn.addEventListener('click', ()=> {
    document.body.classList.toggle('theme-dark');
  });

  // ===== Fullscreen (auto-dark on enter) =====
  const isFs = ()=> document.fullscreenElement || document.webkitFullscreenElement;
  const enterFs = async () => {
    try {
      if (panel.requestFullscreen) await panel.requestFullscreen();
      else if (panel.webkitRequestFullscreen) await panel.webkitRequestFullscreen();
    } catch(e){}
  };
  const exitFs = async () => {
    try {
      if (document.exitFullscreen) await document.exitFullscreen();
      else if (document.webkitExitFullscreen) await document.webkitExitFullscreen();
    } catch(e){}
  };
  fullBtn.addEventListener('click', ()=> isFs() ? exitFs() : enterFs());
  document.addEventListener('fullscreenchange', ()=>{
    const on = !!isFs();
    document.body.classList.toggle('theme-dark', on);      // auto dark
    document.body.classList.toggle('is-fullscreen', on);   // taller canvas
    fullBtn.textContent = on ? 'â›¶ Exit' : 'â›¶ Full';
  });

  // ===== PDF.js =====
  let pdfjs;
  try { pdfjs = await waitForPdfjs(); }
  catch(e){
    document.getElementById('book').innerHTML = "<div style='padding:24px;color:#b91c1c'>Failed to load PDF.js library.</div>";
    return;
  }

  try {
    // Worker according to version
    const v = pdfjs.version || '';
    if (v.startsWith('4.')) {
      pdfjs.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";
    } else {
      pdfjs.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
    }

    const loadingEl = document.getElementById('loading');
    const barEl = document.getElementById('bar');
    const hintEl = document.getElementById('hint');
    const bookEl = document.getElementById('book');
    const counterEl = document.getElementById('pageCounter');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // Render PDF pages â†’ images (HD)
    const task = pdfjs.getDocument(PDF_URL);
    const pdf = await task.promise;
    const pageCount = pdf.numPages;

    const deviceScale = (window.devicePixelRatio || 1);
    const scale = Math.min(3.0, deviceScale * 2.25); // crisp; tune down if heavy
    const images = [];
    let baseWidth = 800, baseHeight = 1120;

    for (let i = 1; i <= pageCount; i++) {
      hintEl.textContent = "Rendering page " + i + " / " + pageCount;
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: (i===1? scale*1.1 : scale) });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { alpha: false });
      ctx.imageSmoothingEnabled = false;
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      await page.render({ canvasContext: ctx, viewport }).promise;

      if (i === 1) { baseWidth = canvas.width; baseHeight = canvas.height; }
      images.push(canvas.toDataURL('image/png')); // lossless for sharp text

      barEl.style.width = ((i / pageCount) * 100).toFixed(1) + "%";
      await new Promise(r => setTimeout(r, 6));
    }

    // Flipbook â€” 2-page spread
    const pageFlip = new St.PageFlip(bookEl, {
      width: baseWidth,
      height: baseHeight,
      size: "stretch",
      minWidth: 320,
      maxWidth: 3200,
      minHeight: 320,
      maxHeight: 5000,
      showCover: true,
      drawShadow: true,
      maxShadowOpacity: 0.25,
      flippingTime: 720,
      usePortrait: false,
      mobileScrollSupport: true,
    });
    pageFlip.loadFromImages(images);

    const updateCounter = () => {
      counterEl.textContent = "Page " + (pageFlip.getCurrentPageIndex() + 1) + " / " + pageFlip.getPageCount();
    };
    pageFlip.on('flip', updateCounter);
    pageFlip.on('init', updateCounter);
    pageFlip.on('update', updateCounter);

    prevBtn.addEventListener('click', () => pageFlip.flipPrev());
    nextBtn.addEventListener('click', () => pageFlip.flipNext());
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') pageFlip.flipPrev();
      if (e.key === 'ArrowRight') pageFlip.flipNext();
      if (e.key === 'f' || e.key === 'F') fullBtn.click();    // quick full
    });

    // Initial states
    setZoom(1.0);
    loadingEl.remove();
    updateCounter();
  } catch (err) {
    console.error(err);
    const bookEl = document.getElementById('book');
    bookEl.innerHTML =
      "<div style='padding:24px;color:#b91c1c'>Failed to load flipbook.<br/>" +
      "Check: <code>" + (new URL(PDF_URL, location.href)).href + "</code><br/>" +
      "Error: <code>" + (err && (err.message || err.toString())) + "</code></div>";
  }
});
</script>
</body>
</html>
